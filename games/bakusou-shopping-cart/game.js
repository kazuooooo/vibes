class ShoppingCartGame {
    constructor() {
        this.gameArea = document.getElementById('gameArea');
        this.player = document.getElementById('player');
        this.scoreElement = document.getElementById('score');
        this.speedElement = document.getElementById('speed');
        this.gameStatus = document.getElementById('gameStatus');
        this.startButton = document.getElementById('startButton');
        this.restartButton = document.getElementById('restartButton');
        this.gameOverModal = document.getElementById('gameOverModal');
        this.finalScore = document.getElementById('finalScore');
        this.modalRestartButton = document.getElementById('modalRestartButton');

        // „Ç≤„Éº„É†Áä∂ÊÖã
        this.gameState = 'waiting'; // 'waiting', 'playing', 'gameOver'
        this.score = 0;
        this.speed = 5;
        this.playerPosition = 250; // ÂàùÊúü‰ΩçÁΩÆÔºà‰∏≠Â§ÆÔºâ
        this.gameObjects = []; // „Ç¢„Ç§„ÉÜ„É†„Å®ÈöúÂÆ≥Áâ©
        this.keys = {};
        this.lastSpeedDecay = Date.now();
        this.lastScoreUpdate = Date.now();

        // „Ç≤„Éº„É†Ë®≠ÂÆö
        this.gameAreaWidth = 560;
        this.gameAreaHeight = 400;
        this.playerWidth = 40;
        this.playerSpeed = 5;
        this.maxSpeed = 15;
        this.minSpeed = 1;

        // „Ç¢„Ç§„ÉÜ„É†„Å®ÈöúÂÆ≥Áâ©„ÅÆÁ®ÆÈ°û
        this.items = ['üçé', 'üçû', 'ü•õ', 'üçå', 'ü•ï', 'üßÄ', 'üçä', 'ü•ñ'];
        this.obstacles = ['üì¶', 'üõí', 'üóÉÔ∏è', 'üöß', '‚ö†Ô∏è'];

        this.init();
    }

    init() {
        this.setupEventListeners();
        this.updateDisplay();
    }

    setupEventListeners() {
        // „Çπ„Çø„Éº„Éà„Éú„Çø„É≥
        this.startButton.addEventListener('click', () => this.startGame());
        this.restartButton.addEventListener('click', () => this.restartGame());
        this.modalRestartButton.addEventListener('click', () => this.restartGame());

        // „Ç≠„Éº„Éú„Éº„ÉâÊìç‰Ωú
        document.addEventListener('keydown', (e) => {
            this.keys[e.code] = true;
            e.preventDefault();
        });

        document.addEventListener('keyup', (e) => {
            this.keys[e.code] = false;
        });

        // „Çø„ÉÉ„ÉÅÊìç‰ΩúÔºà„É¢„Éê„Ç§„É´Ôºâ
        this.gameArea.addEventListener('touchstart', (e) => {
            e.preventDefault();
            const touch = e.touches[0];
            const rect = this.gameArea.getBoundingClientRect();
            const touchX = touch.clientX - rect.left;
            const centerX = rect.width / 2;

            if (touchX < centerX) {
                this.keys['ArrowLeft'] = true;
            } else {
                this.keys['ArrowRight'] = true;
            }
        });

        this.gameArea.addEventListener('touchend', (e) => {
            e.preventDefault();
            this.keys['ArrowLeft'] = false;
            this.keys['ArrowRight'] = false;
        });

        // „ÇØ„É™„ÉÉ„ÇØÊìç‰ΩúÔºàPCÔºâ
        this.gameArea.addEventListener('mousedown', (e) => {
            if (this.gameState !== 'playing') return;
            
            const rect = this.gameArea.getBoundingClientRect();
            const clickX = e.clientX - rect.left;
            const centerX = rect.width / 2;

            if (clickX < centerX) {
                this.keys['ArrowLeft'] = true;
            } else {
                this.keys['ArrowRight'] = true;
            }
        });

        this.gameArea.addEventListener('mouseup', () => {
            this.keys['ArrowLeft'] = false;
            this.keys['ArrowRight'] = false;
        });
    }

    startGame() {
        this.gameState = 'playing';
        this.score = 0;
        this.speed = 5;
        this.playerPosition = this.gameAreaWidth / 2 - this.playerWidth / 2;
        this.gameObjects = [];
        this.lastSpeedDecay = Date.now();
        this.lastScoreUpdate = Date.now();

        this.startButton.style.display = 'none';
        this.restartButton.style.display = 'none';
        this.gameOverModal.style.display = 'none';

        this.updateDisplay();
        this.gameLoop();
        this.spawnObjects();
    }

    restartGame() {
        this.gameState = 'waiting';
        this.startButton.style.display = 'inline-block';
        this.restartButton.style.display = 'none';
        this.gameOverModal.style.display = 'none';
        
        // „Ç≤„Éº„É†„Ç™„Éñ„Ç∏„Çß„ÇØ„Éà„ÇíÂâäÈô§
        this.gameObjects.forEach(obj => {
            if (obj.element && obj.element.parentNode) {
                obj.element.parentNode.removeChild(obj.element);
            }
        });
        this.gameObjects = [];
        
        this.score = 0;
        this.speed = 5;
        this.playerPosition = this.gameAreaWidth / 2 - this.playerWidth / 2;
        this.updateDisplay();
    }

    gameLoop() {
        if (this.gameState !== 'playing') return;

        this.handleInput();
        this.updatePlayer();
        this.updateGameObjects();
        this.checkCollisions();
        this.updateScore();
        this.checkSpeedDecay();
        this.checkGameOver();
        this.updateDisplay();

        requestAnimationFrame(() => this.gameLoop());
    }

    handleInput() {
        // Â∑¶ÁßªÂãï
        if (this.keys['ArrowLeft'] || this.keys['KeyA']) {
            this.playerPosition = Math.max(0, this.playerPosition - this.playerSpeed);
        }

        // Âè≥ÁßªÂãï
        if (this.keys['ArrowRight'] || this.keys['KeyD']) {
            this.playerPosition = Math.min(
                this.gameAreaWidth - this.playerWidth,
                this.playerPosition + this.playerSpeed
            );
        }
    }

    updatePlayer() {
        this.player.style.left = this.playerPosition + 'px';
    }

    spawnObjects() {
        if (this.gameState !== 'playing') return;

        // „Ç¢„Ç§„ÉÜ„É†ÁîüÊàêÔºà2-4ÁßíÈñìÈöîÔºâ
        setTimeout(() => {
            if (this.gameState === 'playing') {
                this.createItem();
                this.spawnObjects();
            }
        }, Math.random() * 2000 + 2000);

        // ÈöúÂÆ≥Áâ©ÁîüÊàêÔºà3-6ÁßíÈñìÈöîÔºâ
        setTimeout(() => {
            if (this.gameState === 'playing') {
                this.createObstacle();
            }
        }, Math.random() * 3000 + 3000);
    }

    createItem() {
        const item = {
            type: 'item',
            x: Math.random() * (this.gameAreaWidth - 30),
            y: -50,
            element: document.createElement('div'),
            emoji: this.items[Math.floor(Math.random() * this.items.length)]
        };

        item.element.className = 'item';
        item.element.textContent = item.emoji;
        item.element.style.left = item.x + 'px';
        item.element.style.top = item.y + 'px';
        item.element.style.animationDuration = (10 / this.speed) + 's';

        this.gameArea.appendChild(item.element);
        this.gameObjects.push(item);
    }

    createObstacle() {
        const obstacle = {
            type: 'obstacle',
            x: Math.random() * (this.gameAreaWidth - 35),
            y: -50,
            element: document.createElement('div'),
            emoji: this.obstacles[Math.floor(Math.random() * this.obstacles.length)]
        };

        obstacle.element.className = 'obstacle';
        obstacle.element.textContent = obstacle.emoji;
        obstacle.element.style.left = obstacle.x + 'px';
        obstacle.element.style.top = obstacle.y + 'px';
        obstacle.element.style.animationDuration = (10 / this.speed) + 's';

        this.gameArea.appendChild(obstacle.element);
        this.gameObjects.push(obstacle);
    }

    updateGameObjects() {
        this.gameObjects.forEach((obj, index) => {
            const rect = obj.element.getBoundingClientRect();
            const gameAreaRect = this.gameArea.getBoundingClientRect();
            
            // „Ç™„Éñ„Ç∏„Çß„ÇØ„Éà„ÅåÁîªÈù¢‰∏ã„Å´Âá∫„Åü„ÇâÂâäÈô§
            if (rect.top > gameAreaRect.bottom) {
                obj.element.parentNode.removeChild(obj.element);
                this.gameObjects.splice(index, 1);
            }
        });
    }

    checkCollisions() {
        const playerRect = this.player.getBoundingClientRect();

        this.gameObjects.forEach((obj, index) => {
            const objRect = obj.element.getBoundingClientRect();

            // ÂΩì„Åü„ÇäÂà§ÂÆö
            if (this.isColliding(playerRect, objRect)) {
                if (obj.type === 'item') {
                    this.collectItem();
                } else if (obj.type === 'obstacle') {
                    this.hitObstacle();
                }

                // „Ç™„Éñ„Ç∏„Çß„ÇØ„Éà„ÇíÂâäÈô§
                obj.element.parentNode.removeChild(obj.element);
                this.gameObjects.splice(index, 1);
            }
        });
    }

    isColliding(rect1, rect2) {
        return !(rect1.right < rect2.left ||
                rect1.left > rect2.right ||
                rect1.bottom < rect2.top ||
                rect1.top > rect2.bottom);
    }

    collectItem() {
        this.score += 100;
        this.speed = Math.min(this.maxSpeed, this.speed + 1);
    }

    hitObstacle() {
        this.speed = Math.max(this.minSpeed, this.speed - 1);
        
        // „Éí„ÉÉ„Éà„Ç®„Éï„Çß„ÇØ„Éà
        this.player.classList.add('hit');
        setTimeout(() => {
            this.player.classList.remove('hit');
        }, 500);

        // ‰∏ÄÊôÇÂÅúÊ≠¢ÂäπÊûú
        const originalGameState = this.gameState;
        this.gameState = 'paused';
        setTimeout(() => {
            if (originalGameState === 'playing') {
                this.gameState = 'playing';
            }
        }, 500);
    }

    updateScore() {
        const now = Date.now();
        const deltaTime = (now - this.lastScoreUpdate) / 1000;

        if (deltaTime >= 1) {
            // Ë∑ùÈõ¢„Éú„Éº„Éä„Çπ
            this.score += 10;
            
            // „Çπ„Éî„Éº„Éâ„Éú„Éº„Éä„Çπ
            this.score += this.speed * 5;
            
            this.lastScoreUpdate = now;
        }
    }

    checkSpeedDecay() {
        const now = Date.now();
        const deltaTime = (now - this.lastSpeedDecay) / 1000;

        if (deltaTime >= 10) {
            this.speed = Math.max(this.minSpeed, this.speed - 1);
            this.lastSpeedDecay = now;
        }
    }

    checkGameOver() {
        // „Çπ„Éî„Éº„Éâ„Åå0‰ª•‰∏ã„Å´„Å™„Å£„ÅüÂ†¥Âêà
        if (this.speed <= 0) {
            this.gameOver();
        }

        // „Éó„É¨„Ç§„É§„Éº„Åå„Ç≥„Éº„ÇπÂ§ñ„Å´Âá∫„ÅüÂ†¥Âêà
        if (this.playerPosition < -this.playerWidth || 
            this.playerPosition > this.gameAreaWidth) {
            this.gameOver();
        }
    }

    gameOver() {
        this.gameState = 'gameOver';
        
        // „Ç≤„Éº„É†„Ç™„Éñ„Ç∏„Çß„ÇØ„Éà„ÇíÂÅúÊ≠¢
        this.gameObjects.forEach(obj => {
            obj.element.style.animationPlayState = 'paused';
        });

        // ÊúÄÁµÇ„Çπ„Ç≥„Ç¢Ë°®Á§∫
        this.finalScore.textContent = this.score;
        this.gameOverModal.style.display = 'flex';
    }

    updateDisplay() {
        this.scoreElement.textContent = this.score;
        this.speedElement.textContent = this.speed;
        
        switch (this.gameState) {
            case 'waiting':
                this.gameStatus.textContent = 'ÂæÖÊ©ü‰∏≠';
                break;
            case 'playing':
                this.gameStatus.textContent = '„Éó„É¨„Ç§‰∏≠';
                break;
            case 'paused':
                this.gameStatus.textContent = '‰∏ÄÊôÇÂÅúÊ≠¢';
                break;
            case 'gameOver':
                this.gameStatus.textContent = '„Ç≤„Éº„É†„Ç™„Éº„Éê„Éº';
                break;
        }
    }
}

// „Ç≤„Éº„É†ÈñãÂßã
document.addEventListener('DOMContentLoaded', () => {
    new ShoppingCartGame();
});